{% extends 'base.html.twig' %}

{% block title %}Mes informations - Dawn GN{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.openEmergencyContactModal = function() {
                Swal.fire({
                    title: 'Ajouter un contact d\'urgence',
                    html: `
                        <div class="mb-4">
                            <input type="text" id="emergency-contact-name" class="text-sm focus:shadow-soft-primary-outline leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding py-2 px-3 font-normal text-gray-800 transition-all focus:border-fuchsia-300 focus:bg-white focus:text-gray-800 focus:outline-none focus:transition-shadow" placeholder="Nom du contact" required>
                        </div>
                        <div class="mb-4">
                            <input type="tel" id="emergency-contact-phone" class="text-sm focus:shadow-soft-primary-outline leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding py-2 px-3 font-normal text-gray-800 transition-all focus:border-fuchsia-300 focus:bg-white focus:text-gray-800 focus:outline-none focus:transition-shadow" placeholder="Numéro de téléphone" required>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Ajouter',
                    cancelButtonText: 'Annuler',
                    customClass: {
                        confirmButton: "border-0 inline-flex w-full justify-center rounded-md bg-gradient-to-tl from-gray-900 to-slate-800 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:scale-102 hover:bg-slate-800 sm:ml-3 sm:w-auto",
                        cancelButton: "mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto"
                    },
                    preConfirm: () => {
                        const name = document.getElementById('emergency-contact-name').value;
                        const phone = document.getElementById('emergency-contact-phone').value;
                        
                        if (!name || !phone) {
                            Swal.showValidationMessage('Veuillez remplir tous les champs');
                            return false;
                        }
                        
                        return fetch('{{ path('app_account_emergency_contact_add') }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name: name,
                                phone: phone
                            })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Une erreur est survenue');
                            }
                            return response.json();
                        })
                        .catch(error => {
                            Swal.showValidationMessage(error.message);
                        });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Contact ajouté !',
                            text: 'Le contact d\'urgence a été ajouté avec succès.',
                            icon: 'success',
                            customClass: {
                                confirmButton: "border-0 inline-flex w-full justify-center rounded-md bg-gradient-to-tl from-gray-900 to-slate-800 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:scale-102 hover:bg-slate-800 sm:ml-3 sm:w-auto"
                            }
                        }).then(() => {
                            window.location.reload();
                        });
                    }
                });
            };

            window.editEmergencyContact = function(id, name, phone) {
                Swal.fire({
                    title: 'Modifier le contact d\'urgence',
                    html: `
                        <div class="mb-4">
                            <input type="text" id="emergency-contact-name" value="${name}" class="text-sm focus:shadow-soft-primary-outline leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding py-2 px-3 font-normal text-gray-800 transition-all focus:border-fuchsia-300 focus:bg-white focus:text-gray-800 focus:outline-none focus:transition-shadow" placeholder="Nom du contact" required>
                        </div>
                        <div class="mb-4">
                            <input type="tel" id="emergency-contact-phone" value="${phone}" class="text-sm focus:shadow-soft-primary-outline leading-5.6 ease-soft block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding py-2 px-3 font-normal text-gray-800 transition-all focus:border-fuchsia-300 focus:bg-white focus:text-gray-800 focus:outline-none focus:transition-shadow" placeholder="Numéro de téléphone" required>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Modifier',
                    cancelButtonText: 'Annuler',
                    customClass: {
                        confirmButton: "border-0 inline-flex w-full justify-center rounded-md bg-gradient-to-tl from-gray-900 to-slate-800 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:scale-102 hover:bg-slate-800 sm:ml-3 sm:w-auto",
                        cancelButton: "mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto"
                    },
                    preConfirm: () => {
                        const name = document.getElementById('emergency-contact-name').value;
                        const phone = document.getElementById('emergency-contact-phone').value;
                        
                        if (!name || !phone) {
                            Swal.showValidationMessage('Veuillez remplir tous les champs');
                            return false;
                        }
                        
                        return fetch(`{{ path('app_account_emergency_contact_edit', {'id': 'CONTACT_ID'}) }}`.replace('CONTACT_ID', id), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name: name,
                                phone: phone
                            })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Une erreur est survenue');
                            }
                            return response.json();
                        })
                        .catch(error => {
                            Swal.showValidationMessage(error.message);
                        });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Contact modifié !',
                            text: 'Le contact d\'urgence a été modifié avec succès.',
                            icon: 'success',
                            customClass: {
                                confirmButton: "border-0 inline-flex w-full justify-center rounded-md bg-gradient-to-tl from-gray-900 to-slate-800 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:scale-102 hover:bg-slate-800 sm:ml-3 sm:w-auto"
                            }
                        }).then(() => {
                            window.location.reload();
                        });
                    }
                });
            };

            window.deleteEmergencyContact = function(id) {
                Swal.fire({
                    title: 'Êtes-vous sûr ?',
                    text: 'Cette action est irréversible',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Oui, supprimer',
                    cancelButtonText: 'Annuler',
                    customClass: {
                        confirmButton: "border-0 inline-flex w-full justify-center rounded-md bg-gradient-to-tl from-red-600 to-rose-400 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:scale-102 hover:opacity-75 sm:ml-3 sm:w-auto",
                        cancelButton: "mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto"
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`{{ path('app_account_emergency_contact_delete', {'id': 'CONTACT_ID'}) }}`.replace('CONTACT_ID', id), {
                            method: 'DELETE'
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Une erreur est survenue');
                            }
                            Swal.fire({
                                title: 'Contact supprimé !',
                                text: 'Le contact d\'urgence a été supprimé avec succès.',
                                icon: 'success',
                                customClass: {
                                    confirmButton: "border-0 inline-flex w-full justify-center rounded-md bg-gradient-to-tl from-gray-900 to-slate-800 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:scale-102 hover:bg-slate-800 sm:ml-3 sm:w-auto"
                                }
                            }).then(() => {
                                window.location.reload();
                            });
                        })
                        .catch(error => {
                            Swal.fire({
                                title: 'Erreur !',
                                text: error.message,
                                icon: 'error',
                                customClass: {
                                    confirmButton: "border-0 inline-flex w-full justify-center rounded-md bg-gradient-to-tl from-gray-900 to-slate-800 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:scale-102 hover:bg-slate-800 sm:ml-3 sm:w-auto"
                                }
                            });
                        });
                    }
                });
            };

            window.sweetTicket = function() {
                Swal.fire({
                    customClass: {
                        text: "!mt-2 sm:!mt-0 !m-0 !text-center sm:!text-left !text-s !text-gray-500 !pl-4 sm:!pl-0 !pr-4 !pb-4 sm:!pr-6 sm:!pb-4 sm:!ml-4 !col-start-1 sm:!col-start-2 !col-end-3",
                        confirmButton: "border-0 inline-flex w-full justify-center rounded-md bg-gradient-to-tl from-gray-900 to-slate-800 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:scale-102 hover:bg-slate-800 sm:ml-3 sm:w-auto",
                    },    
                    width:"50%",
                    text: "Vous le trouverez ici, sur le billet HelloAsso reçu par mail.",
                    imageUrl: "{{ asset('img/billet_info.jpg') }}",
                    imageWidth: "100%",
                    confirmButtonText: "J'ai compris !",
                    animation: false
                });
            };
        });
    </script>
{% endblock %}

{% block body %}
    {% include 'partials/_sidebar.html.twig' %}

    <div class="ease-soft-in-out xl:ml-68.5 relative h-full max-h-screen bg-gray-50 transition-all duration-200">
        {% include 'partials/_navbar.html.twig' %}

        <div class="w-full px-6 mx-auto">
            <div class="relative flex flex-col flex-auto min-w-0 p-4 mt-12 overflow-hidden break-words border-0 shadow-blur rounded-2xl bg-white/80 bg-clip-border backdrop-blur-2xl backdrop-saturate-200">
                <div class="flex flex-wrap -mx-3">
                    <div class="flex-none w-auto max-w-full px-3">
                        <div class="text-base ease-soft-in-out h-18.5 w-18.5 relative inline-flex items-center justify-center rounded-xl text-white transition-all duration-200">
                            <img src="{{ asset('img/bruce-mars.jpg') }}" alt="profile_image" class="w-full shadow-soft-sm rounded-xl" />
                        </div>
                    </div>
                    <div class="flex-none w-auto max-w-full px-3 my-auto">
                        <div class="h-full">
                            <h5 class="mb-1">{{ user.name }}</h5>
                            <p class="mb-0 font-semibold leading-normal text-sm"><span class="font-extrabold text-slate-700">{{ user.registrations|length }}</span> participations</p>
                        </div>
                    </div>
                    <div class="w-full max-w-full px-3 mx-auto mt-4 sm:my-auto sm:mr-0 md:w-1/5 md:flex-none">
                        <div class="relative right-0">
                            N° de billet <a href="javascript:sweetTicket();" id="info" data-target="tooltip_trigger" data-placement="top"><i class="fa fa-question-circle hover:text-slate-700" aria-hidden="true"></i></a> 
                            <div data-target="tooltip" class="hidden px-2 py-1 text-center text-white bg-slate-700 rounded-lg text-sm" role="tooltip">
                                Plus d'informations
                                <div class="invisible absolute h-2 w-2 bg-inherit before:visible before:absolute before:h-2 before:w-2 before:rotate-45 before:bg-inherit before:content-['']" data-popper-arrow></div>
                            </div>
                            : <span class="font-extrabold text-slate-700">{% if user.registrations.empty == false and user.registrations.first %}{{ user.registrations.first.helloasso_ticket }}{% else %}Non renseigné{% endif %}</span>
                            <a href="#" data-target="tooltip_trigger" data-placement="top"><i class="ml-2 fa fa-pencil hover:scale-102 hover:text-slate-700"></i></a>
                            <div data-target="tooltip" class="hidden px-2 py-1 text-center text-white bg-slate-700 rounded-lg text-sm" role="tooltip">
                                Editer le numéro du billet
                                <div class="invisible absolute h-2 w-2 bg-inherit before:visible before:absolute before:h-2 before:w-2 before:rotate-45 before:bg-inherit before:content-['']" data-popper-arrow></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full p-6 mx-auto">
            <div class="flex flex-wrap -mx-3">
                <div class="w-full max-w-full px-3 xl:w-4/12">
                    <div class="relative flex flex-col h-full min-w-0 break-words bg-white border-0 shadow-soft-xl rounded-2xl bg-clip-border">
                        <div class="p-4 pb-0 mb-0 bg-white border-b-0 rounded-t-2xl">
                            <h6 class="mb-0">Mes informations importantes</h6>
                        </div>
                        <div class="flex-auto p-4">
                            <h6 class="font-bold leading-tight uppercase text-xs text-slate-500">Contacts d'urgence</h6>
                            <ul class="mx-3 flex flex-col pl-0 mb-0 rounded-lg">
                                {% if user.emergencyContacts is empty %}
                                    <li class="relative flex items-center px-0 py-2 bg-white border-0 rounded-t-lg text-inherit">
                                        <div class="w-full mx-2 p-1 text-center justify-center bg-slate-100 bg-opacity-40 border rounded border-dashed border-slate-300">
                                            <span onclick="openEmergencyContactModal()" class="text-xs font-semibold leading-tight text-slate-300 cursor-pointer hover:scale-102 hover:text-slate-700 hover:underline"><strong class="font-extrabold">+ </strong>Ajouter un contact</span>
                                        </div>
                                    </li>
                                {% else %}
                                    {% for contact in user.emergencyContacts %}
                                        <li class="relative flex items-center px-0 py-2 bg-white border-0 rounded-t-lg text-inherit">
                                            <div class="flex flex-col items-start justify-center">
                                                <h6 class="mb-0 leading-normal text-sm">{{ contact.name }}</h6>
                                                <p class="mb-0 leading-tight text-xs">{{ contact.phone }}</p>
                                            </div>
                                            <a onclick="editEmergencyContact('{{ contact.id }}', '{{ contact.name }}', '{{ contact.phone }}')" class="inline-block pl-0 pr-4 mb-0 ml-auto font-bold text-center align-middle transition-all bg-transparent border-0 rounded-lg shadow-none cursor-pointer leading-pro text-xs ease-soft-in text-slate-400 hover:text-slate-700 hover:underline" href="javascript:;">Modifier</a>
                                            <a onclick="deleteEmergencyContact('{{ contact.id }}')" class="inline-block pl-4 mb-0 ml-0 font-bold text-center align-middle transition-all bg-transparent border-0 shadow-none cursor-pointer leading-pro text-xs ease-soft-in text-slate-400 hover:text-red-600 hover:underline rounded-none border-l border-slate-300" href="javascript:;">Supprimer</a>
                                        </li>
                                    {% endfor %}
                                    <li class="relative flex items-center px-0 py-2 bg-white border-0 rounded-t-lg text-inherit">
                                        <div class="w-full mx-2 p-1 text-center justify-center bg-slate-100 bg-opacity-40 border rounded border-dashed border-slate-300">
                                            <span onclick="openEmergencyContactModal()" class="text-xs font-semibold leading-tight text-slate-300 cursor-pointer hover:scale-102 hover:text-slate-700 hover:underline"><strong class="font-extrabold">+ </strong>Ajouter un contact</span>
                                        </div>
                                    </li>
                                {% endif %}
                            </ul>
                            
                            <h6 class="mt-6 font-bold leading-tight uppercase text-xs text-slate-500">Allergies</h6>
                            <ul class="mx-3 flex flex-col pl-0 mb-0 rounded-lg">
                                {% if user.allergies is empty %}
                                    <li class="relative flex items-center px-0 py-2 bg-white border-0 rounded-t-lg text-inherit">
                                        <div class="w-full mx-2 p-1 text-center justify-center bg-slate-100 bg-opacity-40 border rounded border-dashed border-slate-300">
                                            <span class="text-xs font-semibold leading-tight text-slate-300 cursor-pointer hover:scale-102 hover:text-slate-700 hover:underline"><strong class="font-extrabold">+ </strong>Ajouter une allergie</span>
                                        </div>
                                    </li>
                                {% else %}
                                    {% for allergy in user.allergies %}
                                        <li class="relative flex items-center px-0 py-2 bg-white border-0 rounded-t-lg text-inherit">
                                            <div class="flex flex-col items-start justify-center">
                                                <h6 class="mb-0 leading-normal text-sm">{{ allergy.name }}</h6>
                                            </div>
                                            <a class="inline-block pl-0 pr-4 mb-0 ml-auto font-bold text-center align-middle transition-all bg-transparent border-0 rounded-lg shadow-none cursor-pointer leading-pro text-xs ease-soft-in text-slate-400 hover:text-slate-700 hover:underline" href="javascript:;">Modifier</a>
                                            <a class="inline-block pl-4 mb-0 ml-0 font-bold text-center align-middle transition-all bg-transparent border-0 shadow-none cursor-pointer leading-pro text-xs ease-soft-in text-slate-400 hover:text-red-600 hover:underline rounded-none border-l border-slate-300" href="javascript:;">Supprimer</a>
                                        </li>
                                    {% endfor %}
                                    <li class="relative flex items-center px-0 py-2 bg-white border-0 rounded-t-lg text-inherit">
                                        <div class="w-full mx-2 p-1 text-center justify-center bg-slate-100 bg-opacity-40 border rounded border-dashed border-slate-300">
                                            <span class="text-xs font-semibold leading-tight text-slate-300 cursor-pointer hover:scale-102 hover:text-slate-700 hover:underline"><strong class="font-extrabold">+ </strong>Ajouter une allergie</span>
                                        </div>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="w-full max-w-full px-3 lg-max:mt-6 xl:w-4/12">
                    <div class="relative flex flex-col h-full min-w-0 break-words bg-white border-0 shadow-soft-xl rounded-2xl bg-clip-border">
                        <div class="p-4 pb-0 mb-0 bg-white border-b-0 rounded-t-2xl">
                            <div class="flex flex-wrap -mx-3">
                                <div class="flex items-center w-full max-w-full px-3 shrink-0 md:w-8/12 md:flex-none">
                                    <h6 class="mb-0">Mon profil</h6>
                                </div>
                                <div class="w-full max-w-full px-3 text-right shrink-0 md:w-4/12 md:flex-none">
                                    <a href="#" data-target="tooltip_trigger" data-placement="top">
                                        <i class="leading-normal fas fa-user-edit text-sm text-slate-400 hover:text-slate-700"></i>
                                    </a>
                                    <div data-target="tooltip" class="hidden px-2 py-1 text-center text-white bg-slate-700 rounded-lg text-sm" role="tooltip">
                                        Editer le profil
                                        <div class="invisible absolute h-2 w-2 bg-inherit before:visible before:absolute before:h-2 before:w-2 before:rotate-45 before:bg-inherit before:content-['']" data-popper-arrow></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex-auto p-4">
                            <hr class="h-px my-2 bg-transparent bg-gradient-to-r from-transparent via-white to-transparent" />
                            <ul class="flex flex-col pl-0 mb-0 rounded-lg">
                                <li class="relative block px-4 py-2 pt-0 pl-0 leading-normal bg-white border-0 rounded-t-lg text-sm text-inherit"><strong class="text-slate-700">Nom :</strong> &nbsp; {{ user.name }}</li>
                                <li class="relative block px-4 py-2 pl-0 leading-normal bg-white border-0 border-t-0 text-sm text-inherit"><strong class="text-slate-700">Email :</strong> &nbsp; {{ user.email }}</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="w-full max-w-full px-3 lg-max:mt-6 xl:w-4/12">
                    <div class="relative flex flex-col h-full min-w-0 break-words bg-white border-0 shadow-soft-xl rounded-2xl bg-clip-border">
                        <div class="p-4 pb-0 mb-0 bg-white border-b-0 rounded-t-2xl">
                            <h6 class="mb-0">Bloc notes</h6>
                        </div>
                        <div class="flex-auto p-4">
                            <ul class="flex flex-col pl-0 mb-0 rounded-lg">
                                {% if user.notes is empty %}
                                    <li class="relative flex items-center px-0 py-2 bg-white border-0 rounded-t-lg text-inherit">
                                        <div class="w-full mx-2 p-1 text-center justify-center bg-slate-100 bg-opacity-40 border rounded border-dashed border-slate-300">
                                            <span class="text-xs font-semibold leading-tight text-slate-300 cursor-pointer hover:scale-102 hover:text-slate-700 hover:underline"><strong class="font-extrabold">+ </strong>Ajouter un commentaire</span>
                                        </div>
                                    </li>
                                {% else %}
                                    {% for note in user.notes %}
                                        <li class="relative flex items-center px-0 py-2 bg-white border-0 rounded-t-lg text-inherit">
                                            <div class="flex flex-col items-start justify-center">
                                                <h6 class="mb-0 leading-normal text-sm">{{ note.content }}</h6>
                                            </div>
                                            <a class="inline-block pl-0 pr-4 mb-0 ml-auto font-bold text-center align-middle transition-all bg-transparent border-0 rounded-lg shadow-none cursor-pointer leading-pro text-xs ease-soft-in text-slate-400 hover:text-slate-700 hover:underline" href="javascript:;">Modifier</a>
                                            <a class="inline-block pl-4 mb-0 ml-0 font-bold text-center align-middle transition-all bg-transparent border-0 shadow-none cursor-pointer leading-pro text-xs ease-soft-in text-slate-400 hover:text-red-600 hover:underline rounded-none border-l border-slate-300" href="javascript:;">Supprimer</a>
                                        </li>
                                    {% endfor %}
                                    <li class="relative flex items-center px-0 py-2 bg-white border-0 rounded-t-lg text-inherit">
                                        <div class="w-full mx-2 p-1 text-center justify-center bg-slate-100 bg-opacity-40 border rounded border-dashed border-slate-300">
                                            <span class="text-xs font-semibold leading-tight text-slate-300 cursor-pointer hover:scale-102 hover:text-slate-700 hover:underline"><strong class="font-extrabold">+ </strong>Ajouter un commentaire</span>
                                        </div>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            {% include 'partials/_footer.html.twig' %}
        </div>
    </div>
{% endblock %}

{% block additional_scripts %}{% endblock %} 